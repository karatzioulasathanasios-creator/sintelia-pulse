<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>SINTELIA Pulse — DOGE/EUR</title>

<style>
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial;background:#fff;color:#111}
.wrap{max-width:520px;margin:auto;padding:14px}
.top{display:flex;justify-content:space-between;align-items:center}
.state{font-size:32px;font-weight:800;padding:14px;border-radius:16px;margin-top:12px;text-align:center}
.hold{background:#fff8e6;border:1px solid #f2ddaa}
.go{background:#e9fbef;border:1px solid #bfeccc}
.nogo{background:#ffecec;border:1px solid #f0b5b5}

.signal{font-size:22px;font-weight:700;text-align:center;margin-top:8px}

.card{border:1px solid #eee;border-radius:16px;padding:14px;margin-top:12px}
.bar{height:12px;background:#eee;border-radius:8px;overflow:hidden;margin-top:6px}
.fill{height:100%;width:0%;background:#1a8f3a;transition:width .3s}

.mode{margin-top:10px;text-align:center}
button{padding:6px 12px;border-radius:10px;border:1px solid #ccc;background:#fafafa}

pre{font-size:11px;background:#fafafa;border:1px solid #eee;padding:10px;border-radius:12px;max-height:240px;overflow:auto}
</style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div><b>SINTELIA Pulse</b><br><small>DOGE / EUR</small></div>
    <div id="conn">CONNECTING</div>
  </div>

  <div id="state" class="state hold">HOLD</div>
  <div id="signal" class="signal">→ WAIT</div>

  <div class="card">
    <div><b id="price">€ —</b></div>

    <div class="bar"><div id="confFill" class="fill"></div></div>
    <small>Confidence</small>

    <div class="mode">
      Mode:
      <button onclick="setMode('calm')">Calm</button>
      <button onclick="setMode('fast')">Fast</button>
      <div id="modeLabel">calm</div>
    </div>

    <details open style="margin-top:10px">
      <summary>Log</summary>
      <pre id="log"></pre>
    </details>
  </div>
</div>

<script>
"use strict";

/* ===== CONFIG ===== */
const API = "https://patient-hill-56b3.fuffy1603.workers.dev/";
let MODE = "calm";

/* ===== STATE ===== */
let prices = [];
let lastState = "HOLD";
let lastChange = 0;
let lastBeep = 0;
let audioReady = false;

/* ===== AUDIO ===== */
const audio = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
document.body.addEventListener("click",()=>audioReady=true);

/* ===== UI HELPERS ===== */
function setConn(t){ document.getElementById("conn").textContent=t; }
function setState(s){
  const el=document.getElementById("state");
  el.className="state "+(s==="GO"?"go":s==="NO-GO"?"nogo":"hold");
  el.textContent=s;
}
function setSignal(s){
  const el=document.getElementById("signal");
  if(s==="GO"){el.textContent="↑ BUY";el.style.color="#1a8f3a";}
  else if(s==="NO-GO"){el.textContent="↓ NO";el.style.color="#c0352b";}
  else{el.textContent="→ WAIT";el.style.color="#777";}
}
function log(t){
  const el=document.getElementById("log");
  const ts=new Date().toISOString().slice(11,19);
  el.textContent+=`[${ts}] ${t}\n`;
  el.scrollTop=el.scrollHeight;
}
function setMode(m){
  MODE=m;
  document.getElementById("modeLabel").textContent=m;
  log("mode="+m);
}

/* ===== OPS ENGINE ===== */
function ops(price){
  const now=Date.now();
  prices.push([now,price]);
  const W=MODE==="fast"?30:60;

  while(prices.length && now-prices[0][0]>W*1000) prices.shift();
  if(prices.length<6) return {state:"HOLD",conf:0};

  const p0=prices[0][1];
  const p1=prices[prices.length-1][1];
  const ret=(p1-p0)/p0;

  let vol=0;
  for(let i=1;i<prices.length;i++) vol+=Math.abs(prices[i][1]-prices[i-1][1]);
  vol/=prices.length;

  const retThr=MODE==="fast"?0.0005:0.0007;
  const noiseThr=p1*(MODE==="fast"?0.001:0.0008);

  let conf=Math.max(0,Math.min(1,(ret/retThr)*(1-vol/noiseThr)));

  if(ret>retThr && vol<noiseThr) return {state:"GO",conf};
  if(ret<-retThr) return {state:"NO-GO",conf:0};
  return {state:"HOLD",conf};
}

/* ===== POLL ===== */
let lastGood=0;

async function poll(){
  try{
    const r=await fetch(API,{cache:"no-store"});
    const d=await r.json();
    const price=Number(d.price);
    if(!Number.isFinite(price)) throw "bad price";

    document.getElementById("price").textContent="€ "+price.toFixed(6);
    setConn("LIVE"); lastGood=Date.now();

    const out=ops(price);
    let s=out.state;
    const now=Date.now();

    if(s!==lastState && now-lastChange<8000) s=lastState;
    if(s!==lastState){lastState=s;lastChange=now;}

    setState(s); setSignal(s);

    const confPct=Math.round(out.conf*100);
    document.getElementById("confFill").style.width=confPct+"%";

    if(s==="GO" && audioReady && now-lastBeep>30000){
      audio.play().catch(()=>{});
      lastBeep=now;
      log(`GO @ €${price.toFixed(6)} conf=${confPct}%`);
    }

  }catch(e){
    if(Date.now()-lastGood>5000) setConn("RECONNECTING");
  }
}

setInterval(poll,1000);
poll();
</script>
</body>
</html>
